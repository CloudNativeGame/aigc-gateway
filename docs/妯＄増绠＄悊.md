AIGC-Gateway支持管理员自定义创建多种AIGC模版，模版初始部署在集群中时，集群不存在对应实例。管理员每部署一个模版，用户Dashboard视图中都会出现一个新的待安装的AIGC模型，当用户选择安装对应模版时，AIGC-Gateway会为该用户创建对应新的实例。

## 前置依赖

管理员需在Kubernetes集群中安装AIGC实例管理组件OKG(OpenKruiseGame)，具体信息请参考：https://openkruise.io/zh/kruisegame/installation

```yaml
$ helm repo add openkruise https://openkruise.github.io/charts/

$ helm repo update

$ helm install kruise openkruise/kruise --version 1.4.0

$ helm install kruise-game openkruise/kruise-game --version 0.3.0
```

## 模版部署

完成安装后，管理员可在集群中部署多套AIGC示例模版。以下是部署一个模版的示例：
```
cat <<EOF | kubectl apply -f -
apiVersion: game.kruise.io/v1alpha1
kind: GameServerSet
metadata:
  name: stable-diffusion-cpu # 该模版的自定义名称
spec:
  replicas: 0 # 初始的实例数目，要设置为0，代表初始不存在任何实例。
  scaleStrategy:
    scaleDownStrategyType: ReserveIds
  gameServerTemplate:
    spec:
      containers:
        - args:
            - --listen
            - --skip-torch-cuda-test
            - --no-half
          command:
            - python3
            - launch.py
          image: yunqi-registry.cn-shanghai.cr.aliyuncs.com/lab/stable-diffusion:v1.0.0-cpu
          name: stable-diffusion
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 7860
            timeoutSeconds: 1
          env:
            - name: POD_NAME #把pod name作为环境变量传入
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
    volumeClaimTemplates: # 为每一个实例分配持久化存储盘，实例释放但数据不丢失
      - apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: user-data
        spec:
          accessModes:
          - ReadWriteOnce
          resources:
            requests:
              storage: 50Gi
          storageClassName: alicloud-disk-essd
          volumeMode: Filesystem
  updateStrategy:
    rollingUpdate:
      podUpdatePolicy: InPlaceIfPossible
      maxUnavailable: 100%
  network:
    networkType: Kubernetes-Ingress
    networkConf:
      - name: IngressClassName
        value: nginx
      - name: Port
        value: "7860" #AIGC实例暴露的端口
      - name: Host 
        #AIGC实例访问的域名，每个实例有各自的域名，用<id>区分。如实例0的域名为instances0...; 实例1的域名为instances1...
        #注意，该域名需要以aigc-gateway的域名结尾，即是aigc-gateway域名的子域名
        value: instances<id>.dashboad.c5464a5f2c39341d3b3eda6e2dd37b505.cn-hangzhou.alicontainer.com
      - name: PathType
        value: ImplementationSpecific
      - name: Path
        value: /
      - name: Annotation
        value: 'nginx.ingress.kubernetes.io/auth-url: https://dashboard.c5464a5f2c39341d3b3eda6e2dd37b505.cn-hangzhou.alicontainer.com/auth'
      - name: Annotation
        value: 'nginx.ingress.kubernetes.io/auth-signin: https://dashboard.c5464a5f2c39341d3b3eda6e2dd37b505.cn-hangzhou.alicontainer.com/sign-in'
      - name: Annotation
        value: 'nginx.ingress.kubernetes.io/auth-snippet: proxy_set_header Cookie $http_cookie;'
EOF
```